<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GitHub Markdown Editor</title>

    <!-- TailwindCSS & daisyUI -->
    <link
      href="https://cdn.jsdelivr.net/npm/daisyui@4.10.1/dist/full.min.css"
      rel="stylesheet"
      type="text/css"
    />
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Markdown Editor (EasyMDE) -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/easymde/dist/easymde.min.css"
    />
    <script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>

    <!-- YAML Parser (js-yaml) -->
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>

    <style>
      /* Custom styles to ensure editor visibility */
      .editor-container .EasyMDE-container {
        height: 100%;
      }
      .editor-container .CodeMirror {
        height: calc(100vh - 300px); /* Adjust height as needed */
      }
    </style>
  </head>
  <body class="bg-base-200">
    <div id="app" class="p-4 md:p-8">
      <!-- Login View -->
      <div id="login-view" class="max-w-xl mx-auto card bg-base-100 shadow-xl">
        <div class="card-body">
          <h2 class="card-title text-2xl mb-4">GitHub 博客编辑器登录</h2>
          <div class="form-control">
            <label class="label"
              ><span class="label-text">GitHub 用户名</span></label
            >
            <input
              id="github-user"
              type="text"
              placeholder="例如 a"
              class="input input-bordered w-full"
            />
          </div>
          <div class="form-control">
            <label class="label"
              ><span class="label-text">GitHub 仓库名</span></label
            >
            <input
              id="github-repo"
              type="text"
              placeholder="例如 blog"
              class="input input-bordered w-full"
            />
          </div>
          <div class="form-control">
            <label class="label"
              ><span class="label-text">个人访问令牌 (PAT)</span></label
            >
            <input
              id="github-pat"
              type="password"
              placeholder="粘贴您的 PAT"
              class="input input-bordered w-full"
            />
          </div>
          <div class="card-actions justify-end mt-4">
            <button id="login-btn" class="btn btn-primary">
              登录并加载文件
            </button>
          </div>
          <div id="login-error" class="text-error mt-2 hidden"></div>
        </div>
      </div>

      <!-- Main Editor View -->
      <div id="main-view" class="hidden">
        <div class="flex justify-between items-center mb-4">
          <h1 class="text-3xl font-bold">博客文章编辑器</h1>
          <button id="logout-btn" class="btn btn-sm btn-outline btn-error">
            登出
          </button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
          <!-- File List -->
          <div class="lg:col-span-1">
            <div class="card bg-base-100 shadow-xl">
              <div class="card-body">
                <h2 class="card-title">文章列表</h2>
                <div id="file-list-container" class="h-screen overflow-y-auto">
                  <ul id="file-list" class="menu bg-base-100 rounded-box">
                    <!-- Files will be dynamically inserted here -->
                  </ul>
                </div>
              </div>
            </div>
          </div>

          <!-- Editor Section -->
          <div id="editor-section" class="lg:col-span-3 hidden">
            <div class="card bg-base-100 shadow-xl">
              <div class="card-body">
                <h2 class="card-title text-2xl mb-4">
                  编辑: <span id="current-file-name" class="font-mono"></span>
                </h2>

                <!-- Metadata Form -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                  <div class="form-control">
                    <label class="label"
                      ><span class="label-text">标题 (Title)</span></label
                    >
                    <input
                      id="meta-title"
                      type="text"
                      class="input input-bordered"
                    />
                  </div>
                  <div class="form-control">
                    <label class="label"
                      ><span class="label-text">类别 (Category)</span></label
                    >
                    <input
                      id="meta-category"
                      type="text"
                      class="input input-bordered"
                    />
                  </div>
                  <div class="form-control">
                    <label class="label"
                      ><span class="label-text"
                        >发布日期 (Published)</span
                      ></label
                    >
                    <input
                      id="meta-published"
                      type="date"
                      class="input input-bordered"
                    />
                  </div>
                  <div class="form-control">
                    <label class="label"
                      ><span class="label-text">更新日期 (Updated)</span></label
                    >
                    <input
                      id="meta-updated"
                      type="date"
                      class="input input-bordered"
                    />
                  </div>
                  <div class="form-control md:col-span-2">
                    <label class="label"
                      ><span class="label-text"
                        >标签 (Tags, 用英文逗号分隔)</span
                      ></label
                    >
                    <input
                      id="meta-tags"
                      type="text"
                      class="input input-bordered"
                    />
                  </div>
                  <div class="form-control md:col-span-2">
                    <label class="label"
                      ><span class="label-text">描述 (Description)</span></label
                    >
                    <textarea
                      id="meta-description"
                      class="textarea textarea-bordered h-24"
                    ></textarea>
                  </div>
                </div>

                <!-- Markdown Editor -->
                <div class="editor-container">
                  <textarea id="markdown-editor"></textarea>
                </div>

                <div class="card-actions justify-end mt-4">
                  <button id="test-output-btn" class="btn btn-accent">
                    测试输出
                  </button>
                  <button id="save-btn" class="btn btn-primary">
                    <span
                      id="save-spinner"
                      class="loading loading-spinner hidden"
                    ></span>
                    保存更改
                  </button>
                </div>
                <div id="save-status" class="mt-2 text-right"></div>
              </div>
            </div>
          </div>

          <!-- Placeholder -->
          <div
            id="placeholder-section"
            class="lg:col-span-3 flex items-center justify-center"
          >
            <div class="text-center">
              <p class="text-xl text-base-content/70">
                请从左侧选择一篇文章开始编辑。
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const state = {
          user: "",
          repo: "",
          pat: "",
          currentFile: {
            path: null,
            sha: null,
          },
        };

        const ui = {
          loginView: document.getElementById("login-view"),
          mainView: document.getElementById("main-view"),
          loginBtn: document.getElementById("login-btn"),
          logoutBtn: document.getElementById("logout-btn"),
          userInput: document.getElementById("github-user"),
          repoInput: document.getElementById("github-repo"),
          patInput: document.getElementById("github-pat"),
          loginError: document.getElementById("login-error"),
          fileList: document.getElementById("file-list"),
          editorSection: document.getElementById("editor-section"),
          placeholderSection: document.getElementById("placeholder-section"),
          currentFileName: document.getElementById("current-file-name"),
          saveBtn: document.getElementById("save-btn"),
          saveSpinner: document.getElementById("save-spinner"),
          saveStatus: document.getElementById("save-status"),
          testOutputBtn: document.getElementById("test-output-btn"),
          meta: {
            title: document.getElementById("meta-title"),
            published: document.getElementById("meta-published"),
            updated: document.getElementById("meta-updated"),
            description: document.getElementById("meta-description"),
            tags: document.getElementById("meta-tags"),
            category: document.getElementById("meta-category"),
          },
        };

        let easyMDE = null;

        // --- GitHub API Functions ---

        async function githubApiRequest(endpoint, options = {}) {
          const url = `https://api.github.com/repos/${state.user}/${state.repo}/${endpoint}`;
          const headers = {
            Authorization: `token ${state.pat}`,
            Accept: "application/vnd.github.v3+json",
            ...options.headers,
          };

          try {
            const response = await fetch(url, { ...options, headers });
            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(
                errorData.message || `HTTP error! status: ${response.status}`
              );
            }
            return await response.json();
          } catch (error) {
            console.error("GitHub API Error:", error);
            throw error;
          }
        }

        async function getFiles() {
          return githubApiRequest("contents/src/content/posts");
        }

        async function getFileContent(path) {
          const data = await githubApiRequest(`contents/${path}`);
          state.currentFile.sha = data.sha;

          // 关键修复：正确地将 Base64 解码为 UTF-8 字符串
          const binaryString = atob(data.content);
          const bytes = new Uint8Array(binaryString.length);
          for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
          }
          const decoder = new TextDecoder("utf-8");
          return decoder.decode(bytes);
        }

        async function updateFile(path, content, sha) {
          // 关键修复：正确地将 UTF-8 字符串编码为 Base64
          const encoder = new TextEncoder();
          const uint8Array = encoder.encode(content);
          let binaryString = "";
          uint8Array.forEach((byte) => {
            binaryString += String.fromCharCode(byte);
          });
          const encodedContent = btoa(binaryString);

          return githubApiRequest(`contents/${path}`, {
            method: "PUT",
            body: JSON.stringify({
              message: `docs: update ${path.split("/").pop()}`,
              content: encodedContent,
              sha: sha,
            }),
          });
        }

        // --- App Logic ---

        function showLoginError(message) {
          ui.loginError.textContent = message;
          ui.loginError.classList.remove("hidden");
        }

        function clearLoginError() {
          ui.loginError.classList.add("hidden");
        }

        function showSaveStatus(message, isError = false) {
          ui.saveStatus.textContent = message;
          ui.saveStatus.className = isError
            ? "mt-2 text-right text-error"
            : "mt-2 text-right text-success";
          setTimeout(() => (ui.saveStatus.textContent = ""), 5000);
        }

        function renderFileList(files) {
          ui.fileList.innerHTML = ""; // Clear existing list
          const mdFiles = files.filter((file) => file.name.endsWith(".md"));
          if (mdFiles.length === 0) {
            ui.fileList.innerHTML = "<li><a>未找到 Markdown 文件</a></li>";
            return;
          }
          mdFiles.forEach((file) => {
            const li = document.createElement("li");
            const a = document.createElement("a");
            a.textContent = file.name;
            a.href = "#";
            a.dataset.path = file.path;
            li.appendChild(a);
            ui.fileList.appendChild(li);
          });
        }

        function parseContent(content) {
          const parts = content.split("---");
          if (parts.length < 3) {
            return { metadata: {}, body: content };
          }
          try {
            const metadata = jsyaml.load(parts[1]);
            const body = parts.slice(2).join("---").trim();
            return { metadata, body };
          } catch (e) {
            console.error("Error parsing YAML metadata:", e);
            return { metadata: {}, body: content };
          }
        }

        function stringifyMetadata(metadata) {
          metadata.draft = metadata.draft || false;
          // 确保 tags 是一个数组
          if (typeof metadata.tags === "string") {
            metadata.tags = metadata.tags
              .split(",")
              .map((tag) => tag.trim())
              .filter(Boolean);
          } else if (!Array.isArray(metadata.tags)) {
            metadata.tags = [];
          }

          // 1. 使用 js-yaml 生成基础的 YAML 字符串
          const yamlString = jsyaml.dump(metadata, {
            lineWidth: -1,
            noQuotes: true,
            flowLevel: 1, // 确保 tags 数组在一行内显示
          });

          // 2. 关键修复：逐行处理，移除特定字段的引号
          const lines = yamlString.split("\n");
          const processedLines = lines.map((line) => {
            // 为 'published', 'updated', 和 'tags' 这几行移除所有单引号
            if (
              line.startsWith("published:") ||
              line.startsWith("updated:") ||
              line.startsWith("tags:")
            ) {
              return line.replace(/'/g, "");
            }
            return line;
          });

          // 3. 重新组合成最终的字符串，并过滤掉末尾可能出现的空行
          return processedLines.filter((line) => line).join("\n");
        }

        function populateEditor(metadata, body) {
          ui.meta.title.value = metadata.title || "";
          ui.meta.published.value = metadata.published
            ? new Date(metadata.published).toISOString().split("T")[0]
            : "";
          ui.meta.updated.value = metadata.updated
            ? new Date(metadata.updated).toISOString().split("T")[0]
            : "";
          ui.meta.description.value = metadata.description || "";
          ui.meta.tags.value = (metadata.tags || []).join(", ");
          ui.meta.category.value = metadata.category || "";

          if (easyMDE) {
            easyMDE.value(body);
          }
        }

        function setTodaysDate() {
          const today = new Date().toISOString().split("T")[0];
          ui.meta.published.value = today;
          ui.meta.updated.value = today;
        }

        async function handleFileClick(e) {
          e.preventDefault();
          if (e.target.tagName !== "A" || !e.target.dataset.path) return;

          // Highlight active file
          document
            .querySelectorAll("#file-list a")
            .forEach((el) => el.classList.remove("active"));
          e.target.classList.add("active");

          const path = e.target.dataset.path;
          state.currentFile.path = path;

          ui.placeholderSection.classList.add("hidden");
          ui.editorSection.classList.remove("hidden");
          ui.currentFileName.textContent = path.split("/").pop();

          try {
            const content = await getFileContent(path);
            const { metadata, body } = parseContent(content);
            populateEditor(metadata, body);
            if (!metadata.published) {
              setTodaysDate();
            }
          } catch (error) {
            showSaveStatus(`加载文件失败: ${error.message}`, true);
          }
        }

        async function handleSave() {
          if (!state.currentFile.path || !state.currentFile.sha) {
            showSaveStatus("没有选择要保存的文件。", true);
            return;
          }

          ui.saveSpinner.classList.remove("hidden");
          ui.saveBtn.classList.add("btn-disabled");

          try {
            const metadata = {
              title: ui.meta.title.value,
              published: ui.meta.published.value,
              updated: ui.meta.updated.value,
              description: ui.meta.description.value,
              image: "", // You can add a field for this if needed
              tags: ui.meta.tags.value
                .split(",")
                .map((t) => t.trim())
                .filter(Boolean),
              category: ui.meta.category.value,
              draft: false, // Defaulting to false
            };

            const body = easyMDE.value();
            const metadataString = stringifyMetadata(metadata);

            const newContent = `---\n${metadataString}\n---\n\n${body}`;

            const result = await updateFile(
              state.currentFile.path,
              newContent,
              state.currentFile.sha
            );
            state.currentFile.sha = result.content.sha; // Update SHA for subsequent saves
            showSaveStatus("文件保存成功！", false);
          } catch (error) {
            showSaveStatus(`保存失败: ${error.message}`, true);
          } finally {
            ui.saveSpinner.classList.add("hidden");
            ui.saveBtn.classList.remove("btn-disabled");
          }
        }
        function handleTestOutput() {
          console.log("--- [测试输出] ---");

          // 1. 从UI收集元数据
          const metadata = {
            title: ui.meta.title.value,
            published: ui.meta.published.value,
            updated: ui.meta.updated.value,
            description: ui.meta.description.value,
            image: "",
            tags: ui.meta.tags.value
              .split(",")
              .map((t) => t.trim())
              .filter(Boolean),
            category: ui.meta.category.value,
            draft: false,
          };

          // 2. 获取Markdown正文
          const body = easyMDE.value();

          // 3. 将元数据对象转换为YAML字符串
          const metadataString = stringifyMetadata(metadata);

          // 4. 组合成最终的Markdown文件内容
          const finalContent = `---\n${metadataString}\n---\n\n${body}`;

          // 5. 打印到控制台
          console.log(finalContent);

          // 6. 在界面上给出提示
          showSaveStatus("内容已输出到开发者控制台。", false);
        }

        async function login() {
          clearLoginError();
          state.user = ui.userInput.value.trim();
          state.repo = ui.repoInput.value.trim();
          state.pat = ui.patInput.value.trim();

          if (!state.user || !state.repo || !state.pat) {
            showLoginError("所有字段均为必填项。");
            return;
          }

          try {
            const files = await getFiles();
            localStorage.setItem(
              "github_editor_data",
              JSON.stringify({
                user: state.user,
                repo: state.repo,
                pat: state.pat,
              })
            );
            ui.loginView.classList.add("hidden");
            ui.mainView.classList.remove("hidden");
            renderFileList(files);
          } catch (error) {
            showLoginError(
              `登录失败: ${error.message}. 请检查您的信息和 PAT 权限。`
            );
          }
        }

        function logout() {
          localStorage.removeItem("github_editor_data");
          state.user = "";
          state.repo = "";
          state.pat = "";
          state.currentFile.path = null;
          state.currentFile.sha = null;

          ui.mainView.classList.add("hidden");
          ui.loginView.classList.remove("hidden");
          ui.userInput.value = "";
          ui.repoInput.value = "";
          ui.patInput.value = "";

          ui.editorSection.classList.add("hidden");
          ui.placeholderSection.classList.remove("hidden");
        }

        function initializeApp() {
          const savedData = localStorage.getItem("github_editor_data");
          if (savedData) {
            const { user, repo, pat } = JSON.parse(savedData);
            ui.userInput.value = user;
            ui.repoInput.value = repo;
            ui.patInput.value = pat;
            login();
          }

          easyMDE = new EasyMDE({
            element: document.getElementById("markdown-editor"),
            spellChecker: false,
            maxHeight: "600px",
          });

          ui.loginBtn.addEventListener("click", login);
          ui.logoutBtn.addEventListener("click", logout);
          ui.fileList.addEventListener("click", handleFileClick);
          ui.testOutputBtn.addEventListener("click", handleTestOutput);
          ui.saveBtn.addEventListener("click", handleSave);
        }

        initializeApp();
      });
    </script>
  </body>
</html>
